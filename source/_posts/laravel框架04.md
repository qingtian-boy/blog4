---
title: laravel框架04
date: 2019-03-05 19:11:52
tags: laravel
---
# 目录

[TOC]

# 一、昨日回顾

## 1、知识点回顾

**能够使用路由群组进行模块(前后台)划分**

```php
<?php
    // 后台
    Route::group(['namespace'=>'Admin', 'prefix'=>'admin'],function(){
        //......
    });
	//前台
Route::group(['namespace'=>'Home'], function(){
    //......
});
```
<!-- more -->
**能够使用命令行创建模型文件**

php artisan make:model [目录/]模型名称

**能够掌握在控制器中使用模型查询、修改、删除数据**

​	//查询所有

​	User::all();

​	//查询一条数据

​	User::first();

​	//根据条件查询
​	User::find( $id );

​	User::where('id', '=', $id)->first();

​	User::where('id', '>=',  $id)->get();

**能够了解在Laravel框架的模板视图中输出验证失败后的错误提示**

**能够了解在模型文件中创建一对一关联模型的方法**

```php
<?php
    public function  user(){
    	$this->hasMay(模型名, 外键, 主键);
	}
```

**能够使用 Validator::make()方式进行数据验证**

​	1.引入 Validator类

​	2.接收需要验证的数据

​	3.自定义验证规则

​	4.自定义提示信息

​	5.调用make()方法

​	6.调用$validator->fails()方法获取验证信息

# 二、文件上传

> Laravel框架中提供了一个文件上传操作类，Illuminate\Http\UploadedFile

```
Laravel中，保存上传可以使用$request->file('name值');或 $request->name值来获取上传处理的操作对象。
使用store方法保存文件的默认路径在storage/app目录。
store('保存路径','存储磁盘空间');
storeAs('保存路径','文件名','存储磁盘空间');
storeAs和store的区别：
store会自动根据上传文件的内容生成md5算法的文件名。
而storeAs则需要我们自己设置文件名。
存储磁盘空间，是Laravel默认情况下，会允许我们保存文件在当前项目服务器的磁盘中， 也允许我们把文件保存到第三方存储磁盘中（例如云存储），所以Laravel允许我们在store或storeAs的最后一个参数中，进行存储磁盘空间的设置。
磁盘空间的配置文件在 config/filesystems.php中。（后面我们的文件几乎都是存储在云存储上）
```

## 1、控制器代码

![1546393526922](1546393526922.png)

![1546393560727](1546393560727.png)

![1546393581043](1546393581043.png)

效果如下：

![1546393599462](1546393599462.png)

==问题：==

​	因为Laravel的访问入口在public目录下，而我们现在保存的文件是在storage/app/目录下。 我们网站的用户是无法访问到storage/app目录下的内容。

解决方案：

​	Laravel的工匠指令提供了创建软件链接的命令，让用户在访问入口的public目录下，也可以访问到storage/app/public目录中的内容。

```cmd
php artisan storage:link
```

![1546393769420](1546393769420.png)

执行成功后，会在项目的根目录下生成storage目录，如下图所示：

![1546393814714](1546393814714.png)

访问图片效果如下：

![1546393850004](1546393850004.png)

# 三、完成管理员功能

## 1、管理员列表

### 1.1、控制器代码

![1546395736831](1546395736831.png)

### 1.2、视图

![1546395793352](1546395793352.png)

### 1.3、效果

![1546395806687](1546395806687.png)

## 2、管理理员编辑

### 2.1、控制器代码

![1546396281751](1546396281751.png)

### 2.2、视图

复制resources/views/admin/admin/add.blade.php文件，并重命名为edit.blade.php

![1546396347694](1546396347694.png)

数据回显

![1546397986918](1546397986918.png)

![1546398034323](1546398034323.png)

![1546398073707](1546398073707.png)

![1546398106840](1546398106840.png)

![1546398135587](1546398135587.png)

效果

![1546398175557](1546398175557.png)

### 2.3、数据更新

![1546400210639](1546400210639.png)

![1546400236180](1546400236180.png)

![1546400259695](1546400259695.png)

### 2.4、效果

![1546400007641](1546400007641.png)

### 作业

​	完善编辑功能里面文件上传功能，如果用户没有修改头像，就不需要修改他默认头像，否则修改。

==必须使用验证器验证文件上传类型与文件大小、文件是否上传成功==

## 3、管理员删除

### 3.1、修改视图代码

修改：resources/views/admin/admin/index.blade.php文件代码

![1546401521867](1546401521867.png)

### 3.2、控制器代码

![1546401193537](1546401193537.png)

### 3.3、效果

![1546401323662](1546401323662.png)

## 4、管理员列表实现分页功能

> 我们手动添加测试数据是不是很麻烦，同时也浪费大把时间。我们可以使用Laravel内置的一个生成数据的数据种子填充技术Seed和Faker插件。

### 4.1、数据种子填充技术

使用工匠指令生成数据种子类文件

```cmd
php artisan make:seeder 类名称
```

> 注意：
>
> ​	类名称的命名规范：因为我们都填充数据给数据表的，一般建议使用表名/模型名称作为类名称。例如：Admin模型填充数据，那么命名为“AdminTableSeeder”

![1546411013511](1546411013511.png)

> 注意：
>
> ​	数据种子填充类文件存放到/database/seeds目录下

代码如下：

![1546411055437](1546411055437.png)

> 说明：
>
> ​	数据种子填充类文件默认会有一个run方法，在run方法中我们就可以使用数据模型进行批量创建数据了。

### 4.2、使用数据种子填充生成测试数据

#### 4.2.1、数据种子填充代码

![1546411268029](1546411268029.png)

#### 4.2.2、执行种子文件

```cmd
语法：php artisan db:seed  --class=类名
```

![1546411327893](1546411327893.png)

效果

![1546411347490](1546411347490.png)

> 注意：
>
> ​	假如数据中某个字段设置了唯一属性，上面这种生成填充数据只能使用一次或修改内容后再生成。接下来我们可以使用Faker类插件来生成高效的测试数据，Faker类的文件路径：vendor\fzaninotto\faker\src\Faker\Factory.php

种子填充代码

![1546411887091](1546411887091.png)

执行填充指令

![1546411833931](1546411833931.png)

![1546411853054](1546411853054.png)

### 4.3、分页显示数据

#### 4.3.1、控制器代码

app/Http/Controllers/Admin/AdminController.php

![1546412216206](1546412216206.png)

#### 4.3.2、视图

resources/views/admin/admin/index.blade.php

![1546412253496](1546412253496.png)

效果如下：

![1546412263576](1546412263576.png)

#### 4.3.3、修改分页类样式

引入css样式文件

![1546412398669](1546412398669.png)

![1546412564262](1546412564262.png)

效果如下：

![1546412575412](1546412575412.png)

# 四、用户登陆与退出

## 1、用户登陆

> 步骤：
> 1.显示登录页面
> ​	1.1显示验证码
> 2.提交登录信息
> 3.控制器接收登录数据
> 4.验证登录信息
> ​	4.1 验证成功，保存登录状态，跳转到后台首页
> ​	4.2 验证失败，返回上一页，提示错误信息
> 5.其他页面实现防翻墙功能

### 1.1、显示登陆页面

#### 1.1.1、新建控制器器

```cmd
php artisan make:controller Admin\PublicController
```

![1546412769443](1546412769443.png)

代码如下：

![1546412840224](1546412840224.png)

#### 1.1.2、视图

将视图文件复制到resources/views/admin/public目录下。注意：需要手动创建public目录

![1546412931034](1546412931034.png)

修改静态资源路径

![1546413234136](1546413234136.png)

#### 1.1.3、定义路由

![1546413058245](1546413058245.png)

> 说明：
>
> ​	显示用户登陆表单页面与验证用户信息使用同一个方法，所以这里使用match路由

效果如下

![1546413245631](1546413245631.png)

#### 1.1.4、调整表单信息

![1546413425813](1546413425813.png)

![1546413470583](1546413470583.png)

#### 1.1.5、显示验证码

> 注意：
>
> ​	Laravel中默认是没有内置验证码功能的。我们可以通过在github或者composer的安装包列表中找到第三方验证码安装包，使用composer进行安装即可。
>
> https://packagist.org/

![1546413524738](1546413524738.png)

安装验证插件

```cmd
composer require mews/captcha
```

![1546414131083](1546414131083.png)

配置config/app.php

![1546414517532](1546414517532.png)

```php
'providers' => [
        // ...
        Mews\Captcha\CaptchaServiceProvider::class,
 ]
    
 'aliases' => [
        // ...
        'Captcha' => Mews\Captcha\Facades\Captcha::class,
 ]
```

![1546414577885](1546414577885.png)

![1546414616857](1546414616857.png)

生成验证配置文件

```cmd
php artisan vendor:publish
```

![1546414663607](1546414663607.png)

效果

![1546414721045](1546414721045.png)

显示验证

修改resources/views/admin/public/login.blade.php代码如下：

![1546414828547](1546414828547.png)

点击切换验证

![1546415390393](1546415390393.png)

效果如下：

![1546415403798](1546415403798.png)

### 1.2、验证用户信息

#### 1.2.1、接收参数

![1546415489160](1546415489160.png)

#### 1.2.2、验证用户信息

![1546416365799](1546416365799.png)

![1546416397089](1546416397089.png)

上面已经跳转返回上一页了，接下来我们可以直接在login的视图页面中，显示错误信息。

![1546416436117](1546416436117.png)

#### 1.2.3、实现多条件登陆

> 随着时间的推移，我们用户注册网站、app的信息越来越多，不仅可以通过email来进行，也可以通过手机号码、微信帐号、自定义帐号等。那么登录的时候，这些信息因为具有唯一性，所以也是可以用来做登录的凭证。
>
> 我们这里也可以实现，让管理员可以通过帐号、邮箱和手机号码进行登录。

##### 控制器代码

验证用户名是否正确

![1546417731360](1546417731360.png)

验证密码是否正确

![1546417770044](1546417770044.png)

保存用户信息到session并跳转

![1546418655205](1546418655205.png)

### 1.3、实现防翻墙功能

> 在以往的项目中，我们都是在公共控制器的构造方法中进行登录状态的验证。
> 其实本质上来说，就是在用户访问到指定控制器之前，先一步进行判断和拦截。
> 在Laravel中，我们不需要使用上面这种方式，Laravel提供了一种中间件的类，这种类会在路由类执行以后，在控制器类执行之前，可以被调用。
> 所以我们可以把类似于验证登录，验证权限的代码，写到中间件中。

#### 1.3.1、middleware-中间件

中间件示意图：

![1546418872267](1546418872267.png)

#### 1.3.2、创建中间件

```cmd
php artisan make:middleware 类名
```

> 注意，中间件的类名建议使用驼峰式，以当前中间件的功能作为命名，例如，检测管理员是否登录的中间件，则类名建议是 CheckAdminLogin

![1546418965167](1546418965167.png)

代码如下：

![1546419004549](1546419004549.png)

> 上面就是我们创建的中间件了，上面handle方法会在中间件被调用的时候自动执行，所以我们一般会把中间件需要执行代码，写在这种方法中。
> 中间件虽然已经创建出来了，但是laravel中并没有识别到，所以接下来，我们需要把中间件注册到项目中。

#### 1.3.3、把中间件注册到项目中

> 在Laravel中， 如果需要在项目中使用某个中间件，则必须把对应的中间件注册到项目中，如何注册呢？
> 就是把中间件的类名写到 \app\Http\Kernel.php文件中。

代码

![1546419162156](1546419162156.png)

#### 1.3.4、在项目中调用中间件

> 在项目中使用中间件有三种方式：
> 1.在控制器的方法中使用【极少用】
>    $this->middleware(‘中间件名称’); 
> 2.在路由规则中使用
>    Route::get()->middleware(‘中间件名称’);
> 3.在路由群组中使用【使用最多】
>    Route::group([ ‘middleware’=>’中间件1:xxx|中间件2|’ ],function(){});
>
> 在开发中，最常用使用的是第3种，接着就是第2种。我们这里使用第3种

路由代码如下：

![1546419453602](1546419453602.png)

#### 1.3.5、在中间件中实现防翻墙

中间件代码如下：

![1546419683523](1546419683523.png)

效果如下：

![1546419702118](1546419702118.png)

## 2、用户退出

### 控制器代码

![1546419897471](1546419897471.png)

### 定义路由

![1546419981893](1546419981893.png)

### 视图

修改resources/views/admin/index/index.blade.php文件代码，如下图所示

![1546420184472](1546420184472.png)

效果如下图所示：

![1546420151056](1546420151056.png)

### 作业：封装验证方法

# 五、总结

文件上传

$request->file( key ); //input表单name属性名称

$request->key; //input表单name属性名称

保存图片

store('保存路径', '存储磁盘空间');

storeAs('保存路径', '新文件名称', '存储磁盘空间');



中间件，防翻墙

创建一个中间件

php artisan make:middeware CheckAdminLogin

注意：需要使用中间必须要注册我们的项目中，app\Http\Kernel.php

```php
protected $routeMiddleware = [
    //......
];
```

怎么样使用中间件

web.php

```php
<?php
    Route::group(['middleware'=>'中间件名称'], function(){
        //......
    });
```

密码验证

密码加密使用 bcrypt($key);

注意：bcrypt 函数加密的密码，需要使用 Hash::check( 表单提交过来值, 从数据表中的加密后文件 );