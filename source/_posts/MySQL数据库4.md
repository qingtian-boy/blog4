---
title: MySQL数据库4
date: 2019-02-20 17:00:19
tags: MySQL
---
# 一、昨日回顾

## 1. 知识回顾

1. 能够使用高级新增语句

   1）replace关键字可以替换insert关键字

   2）一次性新增多条数据：    

   ​	a）insert into 表名 values (数据列表1), (数据列表2), ... (数据列表n);

   ​	b）insert into 表名 (字段列表) values (数据列表1), (数据列表2), ... (数据列表n);

   3）set方式实现新增：insert into 表名 set 字段1=字段1值, 字段2=字段2值, .... 字段n=字段n值;
<!-- more -->
2. 能够理解order by在联合查询中的作用

   order by可以实现排序

   order by 排序字段 后面指定asc或者不写 表示默认情况，默认情况表示按照从上往下升序的顺序进行排序；

   order by 排序字段 后面指定desc表示按照从上往下降序的顺序进行排序；

3. 能够理解4种不同类型的子查询

   标量子查询：本条查询语句的查询条件 是 另外一条查询语句查询出来的单个的值；

   列子查询：本条查询语句的查询条件 是 另外一条查询语句查询出来的一列结果；

   行子查询：本条查询语句的查询条件 是 另外一条查询语句查询出来的一行结果；

   表子查询：本条查询语句所查询的表 是 另外一条查询语句查询出来的一个虚拟表结果集；不要忘了给虚拟表取别名，不取别名将无法执行成功。




## 2. 昨日反馈

![1539263648595](1)



# 二、知识路径

- 高级查询

  ​	连接查询

  ==目标：能够实现连接查询的内连接、外连接操作==

- 数据备份与还原

  ​	为什么使用数据的备份与还原

  ​	数据备份与还原之：文件备份与还原

  ​	数据备份与还原之：mysqldump.exe

  ==目标：能够实现使用mysqldump方式备份与还原数据库==

- 用户权限管理

  ​	用户管理（新增、修改密码、删除）

  ​	用户权限管理

- 外键

  ​	什么是外键

  ​	外键约束

  ==目标：能够懂得和掌握外键的概念==





# 三、今日课程内容：MYSQL数据库

## exists子查询

TIPS：exists子查询和查询的具体数据==没有关系==，只和是否查询的出数据有关。

**==演示案例==**：使用了stu4表和teacher1表。

根据以下要求调整数据表：

```mysql
##删除teacher1表中numb为N10020的干扰数据
delete from teacher1 where id=6;
```



**==要求==**：查询stu4表中所有 属于在职老师带领 的学生信息？ 

**==解答==**：

首先，模拟一个老师离职，

![1539308221522](3)

然后使用exists子查询实现要求的目标：

![1539308185930](2)



**==小结==**：exists子查询和本身查得的具体数据无关，只和查得的数据存不存在与条件相匹配的数据有关。



## 1. 高级查询

TIPS：高级查询部分包括：1）联合查询；2）子查询；3）连接查询；



### 连接查询

连接查询分为：1）内连接；2）外连接；3）自然连接；



内连接：1）==内连接==；2）交叉连接；

外连接：1）==左外连接==；2）==右外连接==；3）全外连接；

自然连接：1）自然内连接；2）自然外连接；



#### 内连接

TIPS：内连接包括：1）内连接；2）交叉连接；

##### 1）内连接

连接方式：使用关键字==inner join==实现。

**==演示案例==**：使用了stu5表

创建以下条件的表：

```mysql
##表结构如下
表1：class
字段：name,stu_nums
翻译：班级名称,学生人数
类型：varchar(30),tinyint

create table class(
name varchar(30),
stu_nums tinyint
);

##测试数据如下
insert into class values
('php27', 30),
('php28', 35),
('php29', 38),
('php23', 42),
('php24', 26);
```

**==需求==**：查询所有学生的信息 以及 这些学生所属班级的信息？ 

**==解答==**：

我们可以按照以前学习的技术，实现分开查询，

先查询所有学生的信息

![1539308926529](4)

再查所有学生所在班级的信息

![1539308953715](5)



虽然我们现在能够分开来查询到所有的目标数据，但是从观察的角度来看的话，其实效果还是不太理想，所以，我们现在使用内连接的方式来改进操作：

![1539309168189](33)



**==小结==**：

1. 使用关键字inner join实现内连接；
2. 使用内连接进行数据连接，如果根据条件连不上，则本条数据将不展示；



**==细节1==**：内连接的简写方式可以省略inner关键字。

![1539310640087](6)



##### 2）内连接所支持的条件

TIPS：内连接支持的条件包括：on、where、using。

###### on和where

a. 在内连接中，where关键字可以代替on关键字；

![1539310748234](7)

b. 一条完整的内连接语句中==不能==同时使用两个以上的关键字on；

![1539310973648](8)

###### using

**==演示案例==**：使用using时，左表和右表连接的条件字段必须同名。

按以下要求对相关数据表作出调整：

```mysql
##将class表中的name字段改名为class_name
alter table class change name class_name varchar(30);
```

![1539311181234](9)



**==要求==**：将表stu5和class使用using方式指定条件进行内连接。

**==解答==**：

![1539311377665](10)



##### 3）交叉连接

**==细节3==**：如果==内连接不指定条件==，就被称为交叉连接。

所谓的交叉连接，指的是将左表的每条数据都与右表的每条数据连接一次。交叉连接又被称为"==笛卡尔积=="。

![1539311849302](11)

![1539311904919](12)



#### 外连接

##### 1）左外连接

TIPS：需要使用关键字 ==left outer join==。

**==演示案例==**：使用了stu5表和class表

**==需求==**：查询所有学生的信息 以及 这些学生所属班级的信息。

**==解答==**：

![1539312352371](13)

![1539312484661](14)



**==小结==**：

1. 左外连接使用的关键字left outer join；
2. 左外连接将会以左表为主表，去连接右表的数据，如果连不上右表的数据，则左表保留，右表的以NULL值填充。



**==细节==**：左外连接简写的方式可以省略outer关键字。 

![1539312587321](15)



##### 2）右外连接

TIPS：需要使用关键字 ==right outer join==。

**==演示案例==**：使用了stu5表和class表

**==需求==**：查询所有学生的信息 以及 这些学生所属班级的信息。

**==解答==**：

![1539312966068](16)

![1539313004883](17)

我们发现右外连接，当右边的数据连不上左边的数据时，则右表的数据保留，而左表的数据被NULL值填充了，所以上图所示会有两条数据右表的保留了，而左表的被设置为NULL值了。

**==小结==**：

1. 右外连接需要使用关键字right outer join来进行连接；
2. 右外连接的连接方式是以右表为主表，去连接左表，当连接不上时，将会保留右表的数据，同时将左表的数据以NULL值填充。



**==细节==**：右外连接简写的方式可以省略outer关键字。

![1539313187077](18)



##### 3）全外连接

TIPS：全外连接在MYSQL不能直接通过某种语法实现，需要通过间接手段实现。

实现全外连接的思路：将左外连接与右外连接==联合==起来。



a. union all联合（全部保留）

![1539314385709](19)



b. union联合（去除重复）

![1539314417216](20)



##### 4）外连接支持的条件

支持的条件：on、using 

**==using演示案例==**：使用using的前提就是两张表中==必须有同名字段==。

![1539314624559](21)



**==细节==**：外连接==不能==使用where代替on。

![1539314723920](22)



#### 自然连接

自然连接包括：1）自然内连接；2）自然外连接；



##### 1）自然内连接

概念：自然内连接  ==**等同于**==  内连接使用using条件。 

连接方法：使用关键字==**natural  join**==



**==演示案例==**：使用了stu3和class表

**==需求==**：查询所有学生的信息 以及 这些学生所属班级的信息。

**==解答==**：

![1539315027474](24)

![1539315002338](23)



##### 2）自然外连接

自然外连接包括：a）自然左外连接；b）自然右外连接；



###### 自然左外连接

连接方法：使用==**natural  left  join**==关键字实现，等同于 左外连接使用using条件。

**==演示案例==**：使用了stu5和class表

**==需求==**：查询所有学生的信息 以及 这些学生所属班级的信息。

**==解答==**：

![1539315290047](26)



###### 自然右外连接

连接方法：使用==**natural  right  join**==关键字实现，等同于 右外连接使用using条件。

**==演示案例==**：使用了stu5和class表

**==需求==**：查询所有学生的信息 以及 这些学生所属班级的信息。

**==解答==**：

![1539315328235](27)



## 2. 数据备份与还原

### 为什么使用数据的备份与还原

数据几乎是所有项目的生命线，当出现突发灾难情况的时候，比如数据丢失，遭到攻击等情况时，我们需要提前做一些准备性的工作，预防这些灾难发生后，项目无法正常运作的灾难后果。

 

在MYSQL中，我们有许多方式能够备份和还原数据。我们可以利用这些方式，提前做好准备，以防灾难发生后无法恢复数据的尴尬局面。



### 数据备份与还原之：文件备份与还原

**==注意==**：文件备份的形式==只支持MyISAM引擎==。 



MyISAM引擎的数据表文件有三个，分别是： 

![1534477003282](25)



**==演示案例==**：使用文件备份与还原的方式备份数据表。

第一步，在MYSQL中创建一个新的数据库db4，

![1539316110350](28)

第二步，将db1数据库下的stu2表的三个文件复制一份，

![1539316198085](29)

第三步，将上一步所复制的三个文件粘贴到mysql5.5.2/data/db4中，

![1539316363019](30)

第四步，检测备份的数据表是否能够正常使用，

![1539316559161](31)



### 数据备份与还原之：mysqldump.exe

备份说明：我们需要通过使用mysqldump.exe可执行文件来进行数据表的备份，这种方式==不限制引擎==的使用。 



mysqldump.exe文件所在目录：

![1534477876272](32)

**==演示案例==**：使用mysqldump的方式备份数据表。

第一步，执行备份整个db1数据库的指令，

![1539327489497](34)

执行成功后，我们在目标目录day10/code中发现了一个新的文件db1.sql，

![1539327532770](35)

第二步，实现通过备份的文件还原数据，

![1539327714275](36)



## 3. 用户权限管理

### 用户管理（新增、修改密码、删除）

查看当前用户表中MYSQL用户信息：

![1539328494835](37)

![1539328511950](38)



#### 新增用户

语句语法：==**create  user**  '帐号'**@**'IP地址'  **identified  by**  '原始密码';==



**==演示案例==**：添加用户zhangsan；密码为1234567

![1539328785697](39)

新开一个cmd黑窗口，使用新的帐号密码进行登录：

![1539328840006](40)



#### 修改用户的密码

##### 超级管理员修改用户密码

语句语法：==**set  password  for**  '帐号'**@**'IP地址' **=password(**'新密码'**)**;==

**==演示案例==**：

![1539329046585](41)



##### 自己修改自己的密码

语句语法：==**set  password=password(**‘新密码’**)**;== 

**==演示案例==**：

![1539329198930](42)



#### 删除用户

语句语法：==**drop  user**  ‘帐号’**@**’IP地址’;==

![1539329315466](43)



### 用户权限管理

#### 为用户授权操作

语句语法：==**grant**  权限1[, 权限2, …, 权限n]  **on**  库名.表名  **to**  ‘帐号’@’IP地址’;== 

**==注意==**：库名如果是“\*”表示所有数据库;表名如果是”*”表示所有的表。



**==演示案例==**：为zhangsan帐号分配查看db1数据库中stu表数据的权限。

![1539330975416](44)

切换到zhangsan用户所在的黑窗口，查看db1数据库下的stu表，

![1539331022619](45)

除了查看权限，其他的权限都不用有，所以都不能执行，

![1539331073563](46)



#### 查看用户权限

语句语法：==**show  grants  for**  ‘帐号’@’IP地址’;==



**==演示案例==**：

![1539331254163](47)



#### 收回权限

语句语法：==**revoke** 权限1[, 权限2, …, 权限n]  **on**  库名.表名  **from**  ‘帐号’@’IP地址’;==



**==演示案例==**：

![1539331481648](48)



## 4. 外键

使用外键的前提：外键所存在的表必须是==Innodb引擎==的。 



### 什么是外键

概念：如果A表中的a字段关联上了B表中的b字段，我们就说a是表A的外键。

设置外键的语句语法：==**foreign  key**  (外键字段)  **references**  主表  (主表关联字段)  \[删除时执行语句\]   [更新时执行语句]==



**==演示案例==**：

按照以下条件创建测试表：

```mysql
表1：goods
翻译：商品表
字段：id,name,price
翻译：主键id,商品名称,商品价格 
类型：int,varchar(30),decimal(10,2)

create table goods(
id int unsigned primary key auto_increment,
name varchar(30),
price decimal(10, 2)
);

表2：goods_info
翻译：商品详情表
字段：id,goods_id,intro
翻译：主键id,商品表id值,商品描述
类型：int,int,varchar(255)

create table goods_info(
id int unsigned primary key auto_increment,
goods_id int unsigned,
intro varchar(255),
##请补全外键
foreign key (goods_id) references goods (id)
);

##将goods_info表的goods_id设置为外键，关联上goods表的id字段
```

在创建goods_info表的时候，为goods_info表将goods_id字段设置成goods_info表的外键，

![1539333094841](49)

执行成功后，查看表结构，

![1539333165416](50)
再查看建表语句，

![1539333366331](51)



**==小结==**：当我们为goods_info表添加了外键以后，MYSQL会：

1. 将会把外键这个字段设置成索引键；
2. 同时这个外键字段还有有一个专有==外键标识==，比如就是上图中的goods_info_ibfk_1这个值；这个外键标识可以用来删除外键。



#### 删除外键操作

外键标识：即构建外键后，MYSQL自动为该表添加的标识。

删除外键语句语法：==**alter  table**  表名  **drop  foreign  key**  外键标识;==



**==演示案例==**：

![1539334417431](52)

删除外键之后，我们发现索引还在，说明没有删除干净，



==拓展知识==：

删除索引键操作

语句语法：==**alter  table**  表名  **drop  index**  索引字段名;== 

![1539334526032](53)



==**小结**==：要想删除外键，第一步先通过外键标识删除外键；第二步再删除索引键。



#### 添加外键操作

语句语法：==**alter  table**  表名 **add  foreign  key**  (外键字段)  **references**  主表  (主表关联字段)  \[删除时执行语句]  [更新时执行语句]；== 



**==演示案例==**：

![1539334772109](54)



### 外键约束

操作准备：

```mysql
##为goods表添加如下测试数据
insert into goods values
(null, '电脑', 10),
(null, '手机', 15);

##为goods_info表构建数据
insert into goods_info values
(null, 1, '电脑很好用');
```

![1539334943846](55)

**==前情1==**：默认情况下被关联的外键数据是无法删除的。 

**==前情1演示==**：

![1539335148026](56)



**==前情2==**：默认情况下被关联的字段值是无法被修改的。

**==前情2演示==**：

![1539335356991](57)



**==小结==**：==默认情况==下，被外键所关联上的数据，即不能删，也不能改；



#### 外键约束状态

针对删除时：on delete

针对更新时：on update



#### 外键被允许的操作

1）cascade; （级联操作，和主表操作保持一致）

2）set null；（设置为null值）

3）restrict（==默认==）；（拒绝操作）



#### 综合测试外键约束

**==测试==**：设置约束操作，on delete设置成set null操作,on update 设置成cascade操作，分别测试更新和删除效果。

首先，需要先删除现有的外键，

![1539335791585](58)

然后，在添加回外键，并且设置约束操作，

![1539336004590](59)

测试更新时的效果：

![1539336361454](60)

测试删除时的效果：

![1539336478777](61)



拓展知识：清空数据表数据并且重新规划索引的操作：==truncate  [库名.]表名;==



## 7. 全天总结

1. 能够理解并使用exists子查询

   exists子查询和具体查得的数据没有直接关系，只和是否存在满足条件的数据有关，存在则表示条件为true，不存在则表示条件为false;

2. 能够理解并应用内连接查询

   需要通过inner join关键字来实现内连接，其中inner关键字可以省略不写，其特点是：

   1）内连接不会展示连接不上的数据；

3. 能够理解并应用左外连接和右外连接

   左外连接：使用left outer join关键字实现，其中outer可以省略不写，左外连接的特点是：

   1）以左表为主，去连接右表，当左表的数据连不上右表的数据时，那么左表的数据将会保留，而右表的数据将会以NULL值填充；

   右外连接：使用right outer join关键字实现，其中outer可以省略不写，右外连接的特点是：

   1）以右表为主，去连接左表，当右表的数据连不上左表的数据时，那么右表的数据将会保留，而左表的数据将会以NULL值填充；

4. 能够实现整库以及单表的备份和还原

   备份整库： mysqldump -uroot -p密码  db1 > F:/xxxx/xx/x/x.sql   

   备份单表： mysqldump -uroot -p密码  db1 stu stu1 > F:/xxxx/xx/x/x.sql   

   还原：1)必须先切换进某个数据库；2）执行source F:/xxxx/xx/x/x.sql   

5. 能够为mysql创建用户并授予权限

   创建用户：create user '帐号'@'IP地址' identified by '原始密码';

   为用户授权：grant 权限列表 on 库名.表名 to '帐号'@'IP地址';



