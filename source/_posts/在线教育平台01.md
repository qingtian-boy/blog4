---
title: 在线教育平台01
date: 2019-03-06 19:30:17
tags: laravel
---
# 目录

[TOC]

# 一、昨日回顾

## 1、知识点回顾

**能够使用模型类的 paginate 方法实现分页**

​	$data = $model->pageinate(5);	//默认值是15

​	模板中怎么显示页码：$data->links();

**能够了解 Laravel 中文件上传功能**

​	$fileObj = $request->file( key );

​	$fileObj->storage('存储路径', '磁盘存储空间');

​	$fileObj->storageAs('存储路径', '新的文件名称', '磁盘存储空间');

​	文件上传返回文件名称
<!-- more -->
**能够使用 php artisan make:seeder 命令创建种子(数据填充)文件**

​	php artisan make:seeder 种子填充文件名    建议大驼峰法，例如：AdminTableSeeder

​	执行：php artisan db:seed  --class=AdminTableSeeder

**能够说出创建的种子(数据填充)文件所在的目录**

​	项目根目录下database/seeds

**能够使用 composer 方式安装验证码功能类**

​	安装：composer require mews/captcha

​	参数说明：

​	mews	代表着作者名称

​	captcha	代表着包名



​	删除(卸载)：composer remove mews/captcha

**能够使用 captcha 验证规则对错误的验证进行验证**

<input type="text" name="captcha" />

$checks = [

​	'captcha' => 'required|captcha'

];


# 二、在线教育平台

> 接下来我们使用Laravel来完成一个综合性的项目-在线教育平台(仿博学谷)

## 1、项目前后台

### 1.1、博学谷前台

#### 1.1.1、首页

> 功能：
>
> ​	公开课直播
>
> ​	职业课程点播

#### 1.1.2、课程介绍界面

> 功能：
>
> ​	输出课程信息

#### 1.1.3、报名页面(确认订单页面)

> 功能：
>
> ​	登陆跳转功能(登陆完成以后跳转回订单页)
>
> ​	生成订单

#### 1.1.4、支付页面

> 功能：
>
> ​	微信支付(扫码支付)
>
> ​	更新订单信息

#### 1.1.5、会员中心

> 功能：
>
> ​	会员的更新操作

#### 1.1.6、学习中心(云课堂)

> 功能：
>
> ​	显示会员的购买课程
>
> ​	课程的课时显示

#### 1.1.7、课时详情(点播视频播放)

> 功能：
>
> ​	ckplayer播放点播视频
>
> ​		http://www.ckplayer.com/
>
> ​	显示课程的课时信息

#### 1.1.8、会员登陆和注册

> 功能：
>
> ​	短信/邮件发送验证码
>
> ​	多条件登陆
>
> ​	Laravel的Auth用户认证类的使用

### 1.2、h-ui.admin框架实现后台管理

> 项目中后台的功能都是参照前台来实现，前台有多少信息需要后台管理员来管理就需要开发多少功能。所以后台功能和前台都应该是一一对应的。

#### 1.2.1、专业课程模型

> 功能：
>
> 学科管理
>
> 专业管理
>
> ​	点播课程
>
> ​		点播课时
>
> ​	直播课程
>
> ​		直播流管理

#### 1.2.2、会员管理模块

> 功能：
>
> 学生管理
>
> 讲师管理

#### 1.2.3、权限管理模块

> 功能：
>
> 管理员
>
> 角色
>
> 权限

#### 1.2.5、开发周期

> 一共8天时间，前台3天，剩下5天用于后台

#### 1.2.6、开发中使用到的插件功能(高亮为js插件)

==使用datatables数据表格插件对数据进行分页显示==

==使用layer弹窗插件(多弹窗之间的数据交互)==

==zyupload多图片上传==

==webuploader图片上传插件==

使用七牛云直播接口开发直播功能

# 三、项目初始化

> 步骤：
> 1.使用composer安装Laravel
>
> 2.对项目进行配置信息( 本地化、数据库 )
>
> 3.搭建基本项目框架( 先做后台，再做前台 )
>
> 4.对路由进行模块分组
>
> 5.移除掉Laravel自身内置的一些案例文件

## 1、使用composer安装Laravel

以D:\web\路径为案例

安装Laravel

```cmd
composer create-project --prefer-dist laravel/laravel php33xuegu 5.4.*
```

![1551837306818](1551837306818.png)

![1551837338382](1551837338382.png)

## 2、配置项目信息

### 2.1、项目本地化配置

本地时区等相关配置

![1551838139732](1551838139732.png)

### 2.2、数据库配置

#### 2.2.1、新建数据库

```sql
CREATE DATABASE `php33xuegu` CHARACTER SET 'utf8mb4' COLLATE 'utf8mb4_general_ci';
```

![1551838180586](1551838180586.png)

#### 2.2.2、配置数据库

修改：.env

![1551838398371](1551838398371.png)

修改config/database.php

![1551838446251](1551838446251.png)

### 2.3、移除掉Laravel自身内置的一些案例文件

> 1.移除 app\Http\Controllers\Auth目录
>
> ![1551838512111](1551838512111.png)
>
> 2.移除 resources\views\welcome.blade.php
>
> ![1551838563384](1551838563384.png)
>
> 3.移除database/migrations/ 数据迁移目录下的所有文件
>
> ![1551838736615](1551838736615.png)

### 2.4、对路由进行模块分组

打开routes/web.php文件

![1551839091137](1551839091137.png)

## 3、安装智能提示插件

https://packagist.org/

![1551839165021](1551839165021.png)

### 3.1、使用composer安装

```cmd
composer require barryvdh/laravel-ide-helper ^2.4.3
```

![1551839271479](1551839271479.png)

### 3.2、注册到Laravel框架中

打开config/app.php文件添加到providers数组中

![1551839325906](1551839325906.png)

![1551839371820](1551839371820.png)

```php
<?php
   'providers' => [
        //智能提示插件
        Barryvdh\LaravelIdeHelper\IdeHelperServiceProvider::class,
    	//......
   	];
```

### 3.3、生成_ide_helper.php文件

```cmd
php artisan ide-helper:generate
```

![1551839443625](1551839443625.png)

# 四、搭建项目后台首页

> 步骤：
>
> 1.使用工匠指令创建Admin\IndexController控制器
>
> ​	1.1.定义方法
>
> 2.定义路由
>
> 3.显示首页视图

## 1、创建IndexController控制器

```cmd
php artisan make:controller Admin/IndexController
```

![1551839562356](1551839562356.png)

### 1.1、定义方法

![1551839692965](1551839692965.png)

## 2、定义路由

打开routes/web.php

![1551839800890](1551839800890.png)

## 3、视图

> 把静态资源全部放到项目中，放到public目录下，建议根据不同模块分目录存储，例如后台的静态资源存储在back目录下。

### 3.1、复制静态资源文件到项目中

![1551839950408](1551839950408.png)

==强调：不要在public目录下创建和地址(前后台模型)一样名称的文件或目录，否则在PHP测试服务器下会导致错误出现。==

### 3.2、复制视图文件到项目中

把index.html与welcome.html复制到resources/views/admin/index目录下，如下图所示

![1551840045979](1551840045979.png)

![1551840087743](1551840087743.png)

### 3.3、修改静态资源路径

resources/views/admin/index/index.blade.php

![1551840423550](1551840423550.png)

效果：

![1551840451393](1551840451393.png)

### 3.4、分离模板

> 使用模板继承，把一些后台共用的视图代码分离出来

在resources/views/admin目录中新建common.blade.php文件

复制resources/views/admin/index/index.blade.php文件中的内容，只保留公共代码，如下图所示

resources/views/admin/common.blade.php

![1551840822811](1551840822811.png)

### 3.5、调整后台首页视图文件

resources/views/admin/index/index.blade.php

![1551841149739](1551841149739.png)

效果如下：

![1551841160724](1551841160724.png)

### 3.6、修改welcome视图静态资源路径

resources/views/admin/index/welcome.blade.php

![1551841320433](1551841320433.png)

最终效果

![1551841334529](1551841334529.png)

### 4.7、修改后台首页代码

resources\views\admin\index\index.blade.php

![1551841430497](1551841430497.png)

最终效果

![1551841470933](1551841470933.png)

## 4、hi-admin目录

http://www.h-ui.net/Hui-overview.shtml

```
Copyright：h-ui.net	Last Modify：guojunhui	2017.01.01
===================================================================
static/	资源
├── h-ui/				H-ui特有资源
│    ├── css/				样式
│    │    ├── H-ui.reset.css			CSS Reset
│    │    ├── H-ui.css				H-ui.css
│    │    ├── H-ui.min.css			H-ui.css(min版)
│    │    ├── H-ui.ie.css			IE 下兼容css
│    ├── images/			图片资源 
│    ├── js/
│    │    ├── H-ui.js				H-ui核心脚本
│    │    ├── H-ui.min.js			H-ui核心脚本(min版)

Lib/	第三方插件
├── jquery				jQuery类库（v1.9.1）
├── Hui-iconfont			阿里图标字体库（H-ui定制）
├── jquery.SuperSlide			幻灯片组件
├── Validform				表单验证插件
├── jquery.validation			表单验证插件
├── My97DatePicker			日期插件
├── datatables				表格插件
├── nprogress				进度条插件
├── layer				layer弹出层插件
├── laypage				laypage 分页插件
├── html5shiv.js			html5插件，让低版本IE支持html5元素
├── DD_belatedPNG_0.0.8a-min.js		解决IE6png透明
├── swfobject.js			Flash插件
├── expressInstall.swf  		检查flash插件
├── respond.min.js			让IE兼容media
```

# 五、专业课程模块

> 功能概况：
> 我们现在要做的时候后台点播课程相关功能，在线教育平台中，往往课程是有对应的分类， 课程往上一级的分类，主要有，专业、学科。
> 学科 > 专业 > 课程 > 课时

示意图：

![1539158106625](1539158106625.png)

> 接下来，我们要开发点播课程模块的开发步骤：
> 1.学科管理( 专业的分类 ) 
> 2.专业管理
> 3.点播课程的管理
> 4.点播课时的管理

## 1、学科管理

> 思路：
> 学科本身就是对专业的归纳分类，所以不会太多的属性。

```sql
sql：
create table subject (
  id smallint unsigned not null auto_increment comment '主键ID',
  subject_name varchar(150) not null comment '学科名称',
  logo varchar(255) null default null comment '学科logo',
  sort int(11) not null default '0' comment '排序',
  created_at timestamp null default null comment '创建时间',
  updated_at timestamp null default null comment '修改时间',
  deleted_at timestamp null default null comment '删除时间',
  primary key (id),
  unique key (subject_name)
) engine=innodb;
```

我们接下来，需要实现功能，必须先有对应的数据表，和以往==使用sql语句建表==所不同，使用Laravel开发项目，Laravel并不希望我们使用sql语句直接建表，因为sql语句建表，容易在后面开发项目或维护上，因为团队开发项目时，修改表结构会带来一定维护的困难。
所以，为了解决上述的这种问题，Laravel提供了一种叫==数据迁移==的==PHP代码建表==功能，它可以让我们使用代码来建表，同时Laravel对于应用了这种功能创建的表会自动进行版本管理。

### 1.1、数据迁移(Migration)

#### 1.1.1、创建数据迁移文件

> 建议：
>   1. 一个表对应一个数据迁移类，一个类就是一个文件。
>   2. 类名建议以“操作_表名_table”格式命名，那么生成的类文件会在自动存储在==/database/migrations==目录中，文件名格式：YYYY_mm_dd_HHiiss_操作_表名_table.php
>   3. Laravel在默认情况下，database/migrations下，会自动提供两张demo的数据迁移类文件，这个可以删除

```cmd
语法：php artisan make:migration 类名
```

创建学科迁移文件

```cmd
php artisan make:migration create_subject_table
```

![1551843379674](1551843379674.png)

代码如下：

![1551843483091](1551843483091.png)

> 说明：
>
> 上面就是数据迁移类文件的代码，默认情况下，数据迁移类会提供两个操作方法给我们使用，分别为：
> up
>    表示创建/修改表或表结构的操作方法
>    可以理解为，数据库操作的前进步骤，或版本升级
> down
>    表示删除/还原表或表结构
>    可以理解为，数据库操作的后退步骤，或版本降级
> 在artisan工匠指令中，就有数据迁移部分的命令migrate，专门控制数据库操作版本的前进和后退操作
> 前进操作的命令（当运行前进操作命令时，Laravel会自动执行所有未执行的迁移类文件中的up方法代码）：
> php artisan migrate
> 后台操作的命令（==当运行后退操作命令时，Laravel会自动执行所有已执行的迁移类文件中的down方法代码==）：
> php artisan migrate:rollback     后退一个版本
> php artisan migrate:reset        版本重置，回到最初状态，版本 0 

> 注意：
>
> 在数据迁移类文件中，Laravel自动引入了两个工具类，分别是==Schema== 和 ==Blueprint==。
> 首先 Schema 专门用于创建/删除数据表的，而Blueprint专门用于创建/删除/修改数据表中字段的。所以Blueprint类必须配合Schema一起使用才可以。

##### 1.1.1.1、Schema

> Schema门面类位置：Illuminate\Support\Facades\Schema
>
> 创建数据表
> Schema::create($table,$callback)
>    $table：字符串，要创建的表名
>    $callback：匿名函数，在匿名函数中声明表字段代码
>
> 删除数据表
> Schema::dropIfExists($table);
>    $table：字符串，要删除的表名
>
> 更改数据表结构
> Schema::table($table,$callback);
>    $table：字符串，要创建的表名
>    $callback：匿名函数，在匿名函数中声明表结构代码

##### 1.1.1.2、Blueprint

> Blueprint类文件位置：Illuminate\Database\Schema\Blueprint.php
> Blueprint提供大量以SQL关键词为方法名的方法供我们声明结构。常用方法如下：
> $table->increments($field);      # 设置当前字段为主键，并且自动增长，非空，数据类型为无符号int。

##### 1.1.1.3、示例代码

![1551844277477](1551844277477.png)

接下来，我们可以直接执行以下命令，创建一个只有id字段的subject数据表。

```cmd
语法：php artisan migrate
```

![1551844299676](1551844299676.png)

接下来，我们需要回滚当前的创建subject的操作，可以以下两个命令中，任意一个

```
php artisan migrate:rollback         # 回滚到上一步操作
php artisan migrate:reset           # 回滚到最初，相当于清空数据库了
```

![1551844568100](1551844568100.png)

#### 1.1.2、创建学科表

代码如下

database\migrations\2019_03_06_113552_create_subject_table.php

```php
public function up()
{
    //创建数据表
    Schema::create('subject',function(Blueprint $table){
        $table->engine = 'innodb';
        //id smallint unsigned not null auto_increment comment '主键ID',
        $table->smallIncrements('id')->comment('主键ID');
        //subject_name varchar(150) not null comment '学科名称',
        $table->string('subject_name', 150)->comment('学科名称');
        //logo varchar(255) null default null comment '学科logo',
        $table->string('logo', 255)->comment('学科logo');
        //sort int(11) not null default '0' comment '排序',
        $table->integer('sort')->default(0)->comment('排序');
        //created_at timestamp null default null comment '创建时间',
        //updated_at timestamp null default null comment '修改时间',
        $table->timestamps();
        //deleted_at timestamp null default null comment '删除时间',
        $table->softDeletes();
        //unique key (subject_name)
        $table->unique('subject_name');
    });
}

public function down()
{
    //删除数据表
    Schema::dropIfExists('subject');
}
```

执行数据迁移

```cmd
php artisan migrate
```

![1551845100408](1551845100408.png)

> ==注意：==
>
> ​	上面就是我们创建的subject 学科表了，同时Laravel为了可以自动对数据迁移的版本进行跟踪和管理，会自动创建一个migrations的数据表，这个表专门记录我们的数据迁移操作的，所以绝对不能手动删除，而且里面的记录也不能轻易删除，因为如果migrations表中没有记录，则无法对数据迁移文件进行回滚版本操作了。

## 2、专业管理

```sql
SQL语句：
create table `profession` (
  `id` int unsigned not null auto_increment comment '主键ID',
  `subject_id` smallint unsigned not null comment '学科ID',
  `profession_name` varchar(150)  not null comment '专业名称',
  `teacher_ids` text null default null comment '专业老师的ids串，如 10,13,21',
  `profession_desc` text null default null comment '简介',
  `click` int unsigned not null default 0 comment '点击量',
  `sort` int unsigned not null default 0 comment '排序',
  `duration` smallint unsigned not null default 0 comment '专业总时长(单位：小时)',
  `cover` varchar(255) null default null comment '封面图',
  `banner` text null default null comment '轮播图片',
  `is_recommend` tinyint not null default 0 comment '是否是推荐专业(0:不是,1:是)',
  `is_best` tinyint not null default 0 comment '是否是优秀专业(0:不是,1: 是)',
  `is_hot` tinyint not null default 0 comment '是否是热门专业(0:不是,1: 是)',
  `price` decimal(9,2) not null default '0.0' comment '专业价格(单位：元)',
  `sale_price` decimal(9,2) not null default '0.0' comment '优惠价格(单位：元)',
  `expire_at` int not null default 0 comment '有效时间',
  `number` int not null default 0 comment '学习人数',
  `content` text null default null comment '专业详情',
  `created_at` timestamp null default null comment '创建时间',
  `updated_at` timestamp null default null comment '修改时间',
  `deleted_at` timestamp null default null comment '删除时间',
  primary key (`pro_id`),
  unique key (`profession_name`)
) engine=innodb;
```

### 2.1、创建数据迁移类文件

```cmd
php artisan make:migration create_profession_table
```

![1551854837764](1551854837764.png)

代码如下：

database\migrations\2019_03_06_144643_create_profession_table.php

```php
public function up()
{
    //创建表
    Schema::create('profession', function(Blueprint $table){
        $table->engine='innodb';
        //`id` int unsigned not null auto_increment comment '主键ID',
        $table->increments('id')->unsigned()->comment('主键ID');
        //`subject_id` smallint unsigned not null comment '学科ID',
        $table->unsignedSmallInteger('subject_id')->comment('学科ID');
        //`profession_name` varchar(150)  not null comment '专业名称',
        $table->string('profession_name', 150)->comment('专业名称');
        //`teacher_ids` text null default null comment '专业老师的ids串，如 10,13,21',
        $table->text('teacher_ids')->nullable()->comment('专业老师的ids串，如 10,13,21');
        //`profession_desc` text null default null comment '简介',
        $table->text('profession_desc')->default(null)->comment('简介');
        //`click` int unsigned not null default 0 comment '点击量',
        $table->unsignedInteger('click')->default(0)->comment('点击量');
        //`sort` int unsigned not null default 0 comment '排序',
        $table->unsignedInteger('sort')->default(0)->comment('排序');
        //`duration` smallint unsigned not null default 0 comment '专业总时长(单位：小时)',
        $table->unsignedSmallInteger('duration')->default(0)->comment('专业总时长(单位：小时)');
        //`cover` varchar(255) null default null comment '封面图',
        $table->string('cover', 255)->nullable()->comment('封面图');
        //`banner` text null default null comment '轮播图片',
        $table->text('banner')->nullable()->comment('轮播图片');
        //`is_recommend` tinyint not null default 0 comment '是否是推荐专业(0:不是,1:是)',
        $table->tinyInteger('is_recommend')->default(0)->commetn('是否是推荐专业(0:不是,1:是)');
        //`is_best` tinyint not null default 0 comment '是否是优秀专业(0:不是,1: 是)',
        $table->tinyInteger('is_best')->default(0)->commetn('是否是优秀专业(0:不是,1: 是)');
        //`is_hot` tinyint not null default 0 comment '是否是热门专业(0:不是,1: 是)',
        $table->tinyInteger('is_hot')->default(0)->commetn('是否是热门专业(0:不是,1: 是)');
        //`price` decimal(9,2) not null default '0.0' comment '专业价格(单位：元)',
        $table->decimal('price', 9,2)->default(0.0)->comment('专业价格(单位：元)');
        //`sale_price` decimal(9,2) not null default '0.0' comment '优惠价格(单位：元)',
        $table->decimal('sale_price', 9,2)->default(0.0)->comment('优惠价格(单位：元)');
        //`expire_at` int not null default 0 comment '有效时间',
        $table->integer('expire_at')->default(0)->comment('有效时间');
        //`number` int not null default 0 comment '学习人数',
        $table->integer('number')->default(0)->comment('学习人数');
        //`content` text null default null comment '专业详情',
        $table->text('content')->nullable()->comment('专业详情');
        //`created_at` timestamp null default null comment '创建时间',
        //`updated_at` timestamp null default null comment '修改时间',
        $table->timestamps();
        //`deleted_at` timestamp null default null comment '删除时间',
        $table->softDeletes();
        //unique key (`profession_name`)
        $table->unique('profession_name');
    });
}

public function down()
{
    Schema::dropIfExists('profession');
}
```

### 2.2、执行数据迁移

```cmd
php artisan migrate
```

![1551856436404](1551856436404.png)

## 3、点播课程

```sql
SQL语句
create table `course` (
  `id` int unsigned not null auto_increment comment '主键ID',
  `profession_id` int not null comment '专业ID',
  `course_name` varchar(150) not null comment '课程名称',
  `price` decimal(9,2) not null default '0.0' comment '价格(单位：元)',
  `sale_price` decimal(9,2) not null default '0.0' comment '优惠价格(单位：元)',
  `cover` varchar(255) null default null comment '封面图',
  `teacher_id` int null default null comment '老师id',
  `course_desc` text  not null comment '课程简介',
  `click` int unsigned not null default 0 comment '点击量',
  `duration` smallint unsigned not null default 0 comment '课程总时长(单位：小时)',
  `sort` int unsigned not null default 0 comment '排序',
  `expire_at` int not null default 0 comment '有效时间',
  `number` int not null default 0 comment '学习人数',
  `content` text null default null comment '课程详情',
  `created_at` timestamp null default null comment '创建时间',
  `updated_at` timestamp null default null comment '修改时间',
  `deleted_at` timestamp null default null comment '删除时间',
  primary key (`id`),
  unique key(`course_name`)
) engine=innodb;
```

### 3.1、创建数据迁移类文件

```cmd
php artisan make:migration create_course_table
```

![1551856706987](1551856706987.png)

代码如下：

database\migrations\2019_03_06_151803_create_courese_table.php

```php
public function up()
{
    //创建表
    Schema::create('courese', function(Blueprint $table){
        $table->engine='innodb';
        //`id` int unsigned not null auto_increment comment '主键ID',
        $table->increments('id')->unsigned()->comment('主键ID');
        //`profession_id` int not null comment '专业ID',
        $table->integer('profession_id')->comment('专业ID');
        //`course_name` varchar(150) not null comment '课程名称',
        $table->string('course_name', 150)->comment('课程名称');
        //`price` decimal(9,2) not null default '0.0' comment '价格(单位：元)',
        $table->decimal('price', 9, 2)->default(0.0)->comment('价格(单位：元)');
        //`sale_price` decimal(9,2) not null default '0.0' comment '优惠价格(单位：元)',
        $table->decimal('sale_price', 9, 2)->default(0.0)->comment('优惠价格(单位：元)');
        //`cover` varchar(255) null default null comment '封面图',
        $table->string('cover', 255)->nullable()->comment('封面图');
        //`teacher_id` int null default null comment '老师id',
        $table->integer('teacher_id')->nullable()->comment('老师id');
        //`course_desc` text  not null comment '课程简介',
        $table->text('course_desc')->comment('课程简介');
        //`click` int unsigned not null default 0 comment '点击量',
        $table->unsignedInteger('click')->default(0)->comment('点击量');
        //`duration` smallint unsigned not null default 0 comment '课程总时长(单位：小时)',
        $table->unsignedSmallInteger('duration')->default(0)->comment('课程总时长(单位：小时)');
        //`sort` int unsigned not null default 0 comment '排序',
        $table->unsignedInteger('sort')->default(0)->comment('排序');
        //`expire_at` int not null default 0 comment '有效时间',
        $table->integer('expire_at')->default(0)->comment('有效时间');
        //`number` int not null default 0 comment '学习人数',
        $table->integer('number')->default(0)->comment('学习人数');
        //`content` text null default null comment '课程详情',
        $table->text('content')->nullable()->comment('课程详情');
        //`created_at` timestamp null default null comment '创建时间',
        //`updated_at` timestamp null default null comment '修改时间',
        $table->timestamps();
        //`deleted_at` timestamp null default null comment '删除时间',
        $table->softDeletes();
        //unique key(`course_name`)
        $table->unique('course_name');
    });
}

public function down()
{
    Schema::dropIfExists('course');
}
```

### 3.2、执行数据迁移

```cmd
php artisan migrate
```

![1551857334094](1551857334094.png)

## 4、点播课时

```sql
SQL语句
create table `lesson` (
  `id` int unsigned not null auto_increment comment '主键ID',
  `course_id` int not null comment '课程ID',
  `lesson_name` varchar(150)  not null comment '课时标题',
  `cover` varchar(255)  default null comment '课时封面',
  `video_address` varchar(255)  not null comment '视频地址',
  `lesson_desc` varchar(255)  default null comment '课时内容描述',
  `duration` int not null default '0' comment '视频分钟数',
  `created_at` timestamp null default null comment '创建时间',
  `updated_at` timestamp null default null comment '修改时间',
  `deleted_at` timestamp null default null comment '删除时间',
  primary key (`lesson_id`)
) engine=innodb;
```

### 4.1、创建数据迁移文件

```cmd
php artisan make:migration create_lesson_table
```

![1551859323118](1551859323118.png)

代码如下：

database\migrations\2019_03_06_160140_create_lesson_table.php

```php
public function up()
{
    //创建表
    Schema::create('lesson', function(Blueprint $table){
        $table->engine='innodb';
        //`id` int unsigned not null auto_increment comment '主键ID',
        $table->increments('id')->unsigned()->comment('主键ID');
        //`course_id` int not null comment '课程ID',
        $table->integer('course_id')->comment('课程ID');
        //`lesson_name` varchar(150)  not null comment '课时标题',
        $table->string('lesson_name', 150)->comment('课时标题');
        //`cover` varchar(255)  default null comment '课时封面',
        $table->string('cover', 255)->default(null)->comment('课时封面');
        //`video_address` varchar(255)  not null comment '视频地址',
        $table->string('video_address', 255)->comment('视频地址');
        //`lesson_desc` varchar(255)  default null comment '课时内容描述',
        $table->string('lesson_desc', 255)->default(null)->comment('课时内容描述');
        //`duration` int not null default '0' comment '视频分钟数',
        $table->integer('duration')->default(0)->comment('视频分钟数');
        //`created_at` timestamp null default null comment '创建时间',
        //`updated_at` timestamp null default null comment '修改时间',
        $table->timestamps();
        //`deleted_at` timestamp null default null comment '删除时间',
        $table->softDeletes();
    });
}

public function down()
{
    Schema::dropIfExists('lesson');
}
```

### 4.2、执行数据迁移

```cmd
php artisan migrate
```

![1551859779140](1551859779140.png)

# 六、学科的CURD

> 步骤：
> 1. 创建模型
> 2. 创建学科的资源控制器
> 3. 声明资源路由
> 4. 在后台首页显示菜单(显示链接)
> 5. 显示列表页面
> 6. 显示列表数据

## 1、创建模型

```cmd
php artisan make:model Models/Subject
```

![1551860265933](1551860265933.png)

代码如下：

![1551860447471](1551860447471.png)

## 2、创建学科的资源控制器

```cmd
php artisan make:controller Admin/SubjectController --resource
```

![1551860534105](1551860534105.png)

默认帮我创建7个方法，代码如下：

![1551860564294](1551860564294.png)

## 3、定义路由

routes/web.php

![1551860647452](1551860647452.png)

## 4、在后台首页显示菜单(显示链接)

### 4.1、后台首页视图代码

resources/views/admin/index/index.blade.php

![1551861634983](1551861634983.png)

### 4.2、学科管理控制器代码

Http/Controllers/Admin/SubjectController.php

![1551861769949](1551861769949.png)

效果如下：

![1551861796575](1551861796575.png)

## 5、显示列表页面

### 5.1、复制模板到项目中

复制到resources/views/admin/subject目录下

![1551861886087](1551861886087.png)

效果

![1551861904912](1551861904912.png)

### 5.2、调整页面样式

resources/views/admin/subject/index.blade.php

![1551862182917](1551862182917.png)

效果如下：

![1551862192528](1551862192528.png)

### 5.3、添加测试数据

> Laravel中提供了 数据种子填充 的功能给我们用于==添加仿真的测试数据==。数据种子填充是一种添加测试数据的方式，本身是一个类，由artisan工匠指令进行调用和创建。

#### 5.3.1、创建数据种子填充类文件

```cmd
语法：php artisan make:seeder 类名
```

> 建议：
>
> 数据种子填充类的类名，以驼峰式格式命名，==格式：表名+TableSeeder.php==
> 例如，subject表，则对应的数据种子填充类名为SubjectTableSeeder

```cmd
php artisan make:seeder SubjectTableSeeder
```

![1551862379396](1551862379396.png)

代码如下：

![1551862781738](1551862781738.png)

```php
public function run(Subject $subject)
{
    //添加学科的测试数据
    $subject->truncate(); //清空数据
    $subject->create(['id'=>1,'subject_name'=>'php', 'logo'=>0, 'sort'=>mt_rand(100,500)]);
    $subject->create(['id'=>2,'subject_name'=>'JavaScript', 'logo'=>0, 'sort'=>mt_rand(50,500)]);
    $subject->create(['id'=>3,'subject_name'=>'全栈', 'logo'=>0, 'sort'=>mt_rand(200,600)]);
    $subject->create(['id'=>4,'subject_name'=>'Python', 'logo'=>0, 'sort'=>mt_rand(1,100)]);
    $subject->create(['id'=>5,'subject_name'=>'UI', 'logo'=>0, 'sort'=>mt_rand(1,100)]);
    $subject->create(['id'=>6,'subject_name'=>'GO', 'logo'=>0, 'sort'=>mt_rand(5,150)]);
}
```

#### 5.3.2、执行数据种子填充类文件

```cmd
php artisan db:seed --class=SubjectTableSeeder
```

![1551862855802](1551862855802.png)

![1551862874340](1551862874340.png)

### 5.4、显示列表数据

> 在h-ui框架中，我们可以使用ajax配合dataTables插件来显示列表数据。
> 看今天笔记中资料里面的==Laravel框架 - dataTables数据表格显示插件.doc==

#### 5.4.1、引入dataTables插件的js文件

resources/views/admin/subject/index.blade.php

![1551863164311](1551863164311.png)

#### 5.4.2、初始化表格插件

resources/views/admin/subject/index.blade.php

首先，给对应的table表格加上一个class或id值

![1551863215109](1551863215109.png)

js中对这个插件进行初始化

![1551864372100](1551864372100.png)

```js
<script>
	$(function(){
	    $('.dataTable').dataTable({
			//每页显示的数据
			'lengthMenu': [[1,5,100,-1], [1,5,100,'所有']],
			//是否开启分页功能 paging:boolen 默认值：true
			'paging': true,
			//是否开启分页辅助信息info:boolen 默认值：true
			'info': true,
			//是否开启搜索功能searching:boolen 默认值：true
			'searching': true,
			//是否开启排序功能 ordering:boolen 默认值: true
			'ordering': true,
			//设置默认排序列
			'order':[[1,'asc']],
			//设置指定列不参排序
			'columnDefs':[{
			    'targets':[0,-1],
				'orderable':false //默认值为: true
			}],
		});
	});
</script>
```

#### 5.4.3、使用Datatables配合ajax获取学科列表数据

控制器代码

Http/Controllers/Admin/SubjectController.php

![1551864821166](1551864821166.png)

```php
public function ajax_list(Request $request,Subject $subject)
    {
        $data = $subject->get();    // 数据
        $cnt   = $subject->count();  // 数据的总数量
        $info = [
            'draw'=>$request->get('draw'),
            'recordsTotal'=>$cnt,
            'recordsFiltered'=>$cnt,
            'data'=>$data,
        ];
        return $info;
    }
```

定义路由

routes/web.php

![1551864887240](1551864887240.png)

视图文件代码

resources/views/admin/subject/index.blade.php

```js
<script>
	$(function(){
	    $('.dataTable').dataTable({
			//每页显示的数据
			'lengthMenu': [[1,5,100,-1], [1,5,100,'所有']],
			//是否开启分页功能 paging:boolen 默认值：true
			'paging': true,
			//是否开启分页辅助信息info:boolen 默认值：true
			'info': true,
			//是否开启搜索功能searching:boolen 默认值：true
			'searching': true,
			//是否开启排序功能 ordering:boolen 默认值: true
			'ordering': true,
			//设置默认排序列
			'order':[[1,'asc']],
			//设置指定列不参排序
			'columnDefs':[{
			    'targets':[0,-1],
				'orderable':false //默认值为: true
			}],
			//是否开启当前记录的状态 stateSave:boolen默认值：false
			'stateSave':true,
			//发送ajax请求获取数据
			'ajax':{
			    'url':'{{ url('admin/subject/ajax_subject') }}',
				'type':'POST',	//请求的类型
				'headers':{ 'X-CSRF-TOKEN' : '{{ csrf_token() }}' }
			},
			//接收数据
			'columns':[
			    //{"data":"字段名", "defaultContent":"默认值 ", "classNmae":"class name"}
				{"data":"a", "defaultContent":"", "className":"text-c"},
				{"data":"id", "defaultContent":"", "className":"text-c"},
				{"data":"subject_name", "defaultContent":"", "className":"text-c"},
				{"data":"logo", "defaultContent":"", "className":"text-c"},
				{"data":"sort", "defaultContent":"", "className":"text-c"},
				{"data":"created_at", "defaultContent":"", "className":"text-c"},
				{"data":"b", "defaultContent":"1", "className":"text-c"},
			],
			'createdRow': function(tr, data, dataIndex ){
			    // console.log(tr)
				//修改第一列的内容
				$(tr).children().eq(0).html(`<input type="checkbox" value="`+data.id+`" name="id[]">`);
				//修改最后一列的内容
				$(tr).children().eq(-1).html(`<a title="编辑" href="javascript:;" onclick="subject_edit('学科编辑','/admin/subject/`+data.id+`/edit','`+data.id+`')" style="text-decoration:none"><i class="Hui-iconfont">&#xe6df;</i></a> <a title="删除" href="javascript:;" onclick="subject_del(this,'`+data.id+`')" class="ml-5" style="text-decoration:none"><i class="Hui-iconfont">&#xe6e2;</i></a>`);
			}
		});
	});
</script>
```

### 5.5、添加学科

> 步骤：
>
> 1.点击列表页显示添加学科的窗口 [ layer弹窗 ]
> 2.显示添加学科的表单信息
> 3.使用ajax提交表单信息到控制器
> 4.控制器接收并校验数据
> 5.保存数据，并返回操作结果
> 前端获取操作结果以后，提示并关闭添加学科的窗口，最后显示数据到学科列表

#### 5.5.1、点击列表页显示添加学科的窗口

resources/views/admin/subject/index.blade.php



#### 5.5.2、显示添加学科的表单信息

> 考虑到我们的学科信息需要填写的字段无非就是 subject_name、logo和sort字段，所以我们把h-ui.admin框架中的角色添加模板复制到过来，改名为: add.blade.php



#### 5.5.3、控制器加载视图

Http/Controllers/Admin/SubjectController.php



效果



#### 5.5.4、修改表单内容

##### 5.5.4.1、模板继承

resources/views/admin/subject/add.blade.php



##### 5.5.4.2、修改表单

resources/views/admin/subject/add.blade.php



效果如下



##### 5.5.4.3、webuploader插件来完成图片上传

对于我们的文件上传，可以使用webuploader插件来完成。
官网：http://fex.baidu.com/webuploader
使用详情查看今天的附件：Laravel框架 - webuploader.doc



因为h-ui.admin框架，已经内置了webuploader插件了，所以我们不需要下载插件，直接在页面中引入webuploader插件的静态资源就可以了。
引入代码：

resources/views/admin/subject/add.blade.php







```html
<div class="row cl">
    <label class="form-label col-xs-4 col-sm-3">logo：</label>
    <div class="formControls col-xs-8 col-sm-9">
        <input type="hidden" name="logo">
        <div id="webuploader-btn">选择文件</div>
        <div class="btn btn-primary radius webuploader-start">开始上传</div>
        {{-- 上传文件的进度条 --}}
        <div id="processing">
            <div class="progress" style="width: 400px">
                <span class="progress-bar">
                    <span class="sr-only" style="width: 0%"></span>
                </span>
            </div>
        </div>
        <div id="webuploader-img"></div>{{-- 预览图片的容器 --}}
    </div>
</div>
```

js代码

```js
// webuploader插件的初始化配置
var uploader = WebUploader.create({
    // 是否开启自动上传
    auto: false,
    // 兼容低版本浏览器时，使用的swf文件地址
    swf: "{{ asset('back') }}/lib/webuploader/0.1.5/Uploader.swf",
    // 选择图片的按钮
    pick: '#webuploader-btn',
    // 是否开启压缩上传图片功能
    resize: false,
    // 限制上传文件的类型
    accept: {
        // extensions: 'gif,jpg,jpeg,png',
    },
    // 设置文件上传地址
    server: "{{url('/admin/upload/subject')}}",
    // 设置Token值
    formData: {
        '_token': '{{ csrf_token() }}',
    },
    // 设置上传文件框的name值
    fileVal: 'subject',
    chunked: true,
});

// webuploader插件的上传图片预览功能
var preview = $('#webuploader-img'); // 显示图片的标签
uploader.on('fileQueued', function(file) {
    uploader.makeThumb(file, function(error, src) {
        preview.empty();
        $('#processing .sr-only').css('width', '0%'); // 清空进度条效果
        if (error) {
            layer.msg("不能预览图片。");
            return;
        }
        preview.html("<img src='" + src +"' />");
    }, 100, 100);
});

// 上传文件的进度
uploader.on('uploadProgress', function(file, percentage) {// percentage 表示上传进度
    $('#processing .sr-only').css('width', percentage * 100 + '%')
});

// 设置点击上传图片
$('.webuploader-start').on('click', function(){
    uploader.upload();
});

// 当前上传文件以后，修改 隐藏域中的文件的图片地址
uploader.on('uploadSuccess', function(file, response){
    if( response.status ){
        $('input[name=logo]').val( response.message );
        layer.msg('上传文件成功了！',{icon:1,time:1500});
    }else{
        preview.empty(); // 清空缩略图
        $('#processing .sr-only').css('width', '0%'); // 清空进度条效果
        layer.msg('上传文件失败了！',{icon:2,time:1500});
    }
});
```

效果：



##### 5.5.4.4、定义方法

Http/Controllers/Admin/SubjectController.php



##### 5.5.4.5、定义路由



#### 5.5.5、控制器接收并处理上传文件

> 为了更好的显示和管理我们的图片资源，我们可以使用第三方存储设备来存储上传文件，这样，可以优化网站的效果。而且像我们这种在线教育平台会存储大量视频、直播视频的网站更加需要第三方存储，从成本上、从网络流量上，都可以极大的降低开发和运营成本。
> 这里，我们使用七牛云存储来保存我们的上传文件。
> 官网：https://portal.qiniu.com/bucket/create
> 要使用七牛云存储资源，则需要使用七牛云的 对象存储 功能。
> 云存储空间：
> 国内：OSS,七牛云，又拍云，腾讯云
> 国外：s3

##### 5.5.5.1、在七牛云的对象存储中创建 存储空间



效果：



> 接下来，有了存储空间以后，我们需要调用七牛云官网提供的接口，来操作项目中上传文件发送到七牛云的存储空间【这个存储空间就等同于我们在七牛云买了一个硬盘】。

##### 5.5.5.2、下载七牛云插件

> 我们在Laravel中，本身的文件上传就支持使用第三方存储设备。可以在github上面找到对应别人封装好的七牛云安装包，直接使用comooposer安装即可使用。
>
> https://packagist.org/
>
> https://packagist.org/packages/itbdw/laravel-storage-qiniu



![1539182685559](1539182685559.png)

```cmd
composer require itbdw/laravel-storage-qiniu
```



##### 5.5.5.3、把安装包注册到项目中

config/app.php

```
config/app.php 里面的 providers 数组， 加上一行 itbdw\QiniuStorage\QiniuFilesystemServiceProvider::calss
```



##### 5.5.5.4、配置config/filesystems.php文件中的storAge存储设备的配置信息



##### 5.5.5.5、把上传文本存储到七牛云存储空间中

app/Http/Controllers/Admin/SubjectController.php



```php
//文件上传
public function upload(Request $request)
{
    $path = key($_FILES);
    $file = $request->file($path);
    $filename = $this->uniqidReal(32) . '.' . $file->extension();
    $info = $file->storeAs($path . date('/Y-m-d'), $filename , 'qiniu');
    if( !$info ){
        return ['status'=>false];
    }
    // config 用于读取laravel中的配置文件的信息
    return ['status'=>true,'message'=> config('filesystems.disks.qiniu.domain') .'/'. $info];
}
```

##### 5.5.5.6、生成一个基于时间戳来生成的唯一文件名

app/Http/Controllers/Admin/SubjectController.php



```php
// 生成基于时间戳的唯一文件名
public function uniqidReal($lenght = 13) {
    // uniqid gives 13 chars, but you could adjust it to your needs.
    if (function_exists("random_bytes")) {
        $bytes = random_bytes(ceil($lenght / 2));
    } elseif (function_exists("openssl_random_pseudo_bytes")) {
        $bytes = openssl_random_pseudo_bytes(ceil($lenght / 2));
    } else {
        throw new Exception("no cryptographically secure random function available");
    }
    return substr(bin2hex($bytes), 0, $lenght);
}
```

#### 5.5.6、数据入库

##### 5.5.6.1、控制器代码

Http/Controllers/Admin/SubjectController.php





```php
public function store(Request $request, Subject $subject)
{
    $data = $request->all();
    // 验证规则
    $checks = [
        'subject_name' => 'required|unique:subject,subject_name',
    ];
    // 错误提示
    $messages = [
        'subject_name.required' => '学科名称不能为空！',
        'subject_name.unique'   => '学科名称已存在！',
    ];

    // 参数1是数据，参数2是验证规则，参数3是错误信息
    $valid = Validator::make($data, $checks, $messages);
    if( $valid->fails() ){
        return ['status'=>false,'message'=> $valid->messages()->all() ];
    }

    // 保存到数据库
    $subject = $subject->create($data);
    if( !$subject->id ){
        return ['status'=>false,'message'=> ['添加学科失败！'] ];
    }

    return ['status'=>true,'message'=> ['添加学科成功！'] ];
}
```

##### 5.5.6.2、视图代码

resources/views/admin/subject/add.blade.php







效果



##### 5.5.6.3、显示列表页中学科的图片

resources/views/admin/subject/index.blade.php



效果



#### 5.5.7、删除学科

> 使用ajax删除学科，注意，这里是软删除。所以不要真的去删除图片。
> 步骤：
> 1.发送ajax到后台控制器
> 2.控制器接收ajax请求，使用delete进行删除，返回操作结果。
> 3.前端接收删除操作结果以后，进行提示并更新页面。

##### 5.5.7.1、发送ajax到后台控制器

视图代码：resources/views/admin/subject/index.blade.php



```js
/*管理员-学科-删除*/
function subject_del(obj,id){
	layer.confirm('学科删除须谨慎，确认要删除吗？',function(index){
		//此处请求后台程序，下方是成功后的前台处理……
		var data = {
		    '_method': 'delete',
			'_token': '{{csrf_token()}}'
		};
		$.post('/admin/subject/'+id, data, function(msg){
		    if(msg.status){
                layer.msg('删除成功',{icon:6,time:1000}, function(){
					location.reload();
                });
			}else{
                layer.msg('删除失败',{icon:5,time:1000});
			}
		});
	});
}
```

控制器代码：app/Http/Controllers/Admin/SubjectController.php



```php
public function destroy(Subject $subject)
{
    if($subject->delete() !== false){
        return ['status'=> true, 'message'=>'删除成功'];
    }else{
        return ['status'=>false, 'message'=>'删除失败'];
    }
}
```

#### 5.5.8、编辑学科

> 类似于添加学科，我们也使用layer弹窗来完成，同样，使用ajax提交数据。
> 步骤：
> 1.点击编辑某一个学科，弹窗编辑学科的弹窗。【前面已经完成了】
> 2.在编辑学科的页面中查询和显示对应学科的内容
> 3.把表单数据提交到控制器中
> 4.控制器接收并验证数据
>    判断是否有图片上传，如果有图片，则删除旧图片，保存新图片。
> ​                       如果没有图片上传，则保留原有图片。
>
> 5. 前端接收操作结果，并进行提示和关闭编辑窗口。

##### 5.5.8.1、显示编辑页面

控制器代码



视图

复制resources/views/admin/subject/add.blade.php文件，并重命名为edit.blade.php



数据回显

resources/views/admin/subject/edit.blade.php





##### 5.5.8.2、更新数据

app/Http/Controllers/Admin/SubjectController.php





```php
public function update(Request $request, Subject $subject)
{
    $data = $request->all();
    // 验证规则
    $checks = [
        'subject_name' => 'required|unique:subject,subject_name,' . $subject->id,
    ];
    // 错误提示
    $messages = [
        'subject_name.required' => '学科名称不能为空！',
        'subject_name.unique'   => '学科名称已存在！',
    ];
    // 参数1是数据，参数2是验证规则，参数3是错误信息
    $valid = Validator::make($data, $checks, $messages);
    if( $valid->fails() ){
        return ['status'=>false,'message'=> $valid->messages()->all() ];
    }
    // 保存编辑的数据
    $res = $subject->update($data);
    if( !$res ){
        return ['status'=>false,'message'=> ['编辑学科失败！'] ];
    }

    return ['status'=>true,'message'=> ['编辑学科成功！'] ];
}
```

# 七、专业的CURD

> 步骤：
>
> 1. 创建模型
> 2. 创建专业的资源控制器
> 3. 声明资源路由
> 4. 在后台首页显示菜单(显示链接)
> 5. 显示列表页面
> 6. 显示列表数据

## 1、创建模型

```cmd
php artisan make:model Models/Profession
```



注意，subject_id是学科的外键id,所以我们需要在专业的模型中，声明专业和学科的关系：
多个专业属于一个学科，所以我们需要使用 hasOne或者belongsTo来声明它们之间的关系，代码：



## 2、创建专业的资源控制器

```cmd
php artisan make:controller Admin/ProfessionController --resource
```



## 3、定义路由

routes/web.php



## 4、在后台首页显示菜单(显示链接)

### 4.1、后台首页视图代码



### 4.2、专业管理控制器代码



## 5、显示列表页面

### 5.1、复制模板到项目中

复制到resources/views/admin/profession目录下



效果如下：

### 5.2、调整页面样式



### 5.3、添加测试数据

#### 5.3.1、创建数据种子填充类文件

```cmd
php artisan make:seeder ProfessionTableSeeder
```

代码如下：

database/seeds/ProfessionTableSeeder.php

```php
public function run(Profession $profession)
{
    // 清空表数据
    $profession->truncate();
    $profession->create(['id'=>1,'subject_id'=>1,'profession_name'=>'PHP入门班','teacher_ids'=>[1,3,5,7,8,9],'price'=>199,'sale_price'=>100,'expire_at'=>183,'number'=>mt_rand(10,1000),'duration'=>mt_rand(200,700)]);
    $profession->create(['id'=>2,'subject_id'=>1,'profession_name'=>'PHP进阶班','teacher_ids'=>[1,3,5,7,8,9],'price'=>399,'sale_price'=>200,'expire_at'=>365,'number'=>mt_rand(10,1000),'duration'=>mt_rand(200,700)]);
    $profession->create(['id'=>3,'subject_id'=>1,'profession_name'=>'PHP高级班','teacher_ids'=>[1,3,5,7,8,9],'price'=>699,'sale_price'=>300,'expire_at'=>365,'number'=>mt_rand(10,1000),'duration'=>mt_rand(200,700)]);
    $profession->create(['id'=>4,'subject_id'=>1,'profession_name'=>'PHP就业班','teacher_ids'=>[1,3,5,7,8,9],'price'=>999,'sale_price'=>400,'expire_at'=>365,'number'=>mt_rand(10,1000),'duration'=>mt_rand(200,700)]);

    $profession->create(['id'=>5,'subject_id'=>2,'profession_name'=>'Javascript入门班','teacher_ids'=>[1,3,5,7,8,9],'price'=>399,'sale_price'=>300,'expire_at'=>183,'number'=>mt_rand(100,2000),'duration'=>mt_rand(300,800)]);
    $profession->create(['id'=>6,'subject_id'=>2,'profession_name'=>'Javascript进阶班','teacher_ids'=>[1,3,5,7,8,9],'price'=>599,'sale_price'=>400,'expire_at'=>365,'number'=>mt_rand(100,2000),'duration'=>mt_rand(300,800)]);
    $profession->create(['id'=>7,'subject_id'=>2,'profession_name'=>'Javascript高级班','teacher_ids'=>[1,3,5,7,8,9],'price'=>899,'sale_price'=>500,'expire_at'=>365,'number'=>mt_rand(100,2000),'duration'=>mt_rand(300,800)]);
    $profession->create(['id'=>8,'subject_id'=>2,'profession_name'=>'Javascript就业班','teacher_ids'=>[1,3,5,7,8,9],'price'=>1199,'sale_price'=>600,'expire_at'=>365,'number'=>mt_rand(100,2000),'duration'=>mt_rand(300,800)]);
}
```

#### 5.3.2、执行数据种子填充类文件

```cmd
php artisan db:seed --class=ProfessionTableSeeder
```



执行数据种子填充类的时候报错了，错误如下：



> 错误原因是老师的id串是数组，但是我们存储到数据库中必须是字符串的格式，所以报错。
> 解决：
> Laravel提供了模型的属性转换来解决数组和字符串之间的自动转换。

修改Profession模型文件代码如下：

Models/Profession.php



效果如下：



### 5.4、显示列表数据

#### 5.4.1、引入dataTables插件的js文件

resources/views/admin/profession/index.blade.php



#### 5.4.2、初始化表格插件

resources/views/admin/profession/index.blade.php

首先，给对应的table表格加上一个class或id值

#### 5.4.3、使用Datatables配合ajax获取学科列表数据

控制器代码

Http/Controllers/Admin/ProfessionController.php

```php
public function ajax_list(Request $request,Profession $profession)
{
    $data = $profession->get();    // 数据
    $cnt   = $profession->count();  // 数据的总数量
    $info = [
        'draw'=>$request->get('draw'),
        'recordsTotal'=>$cnt,
        'recordsFiltered'=>$cnt,
        'data'=>$data,
    ];
    return $info;
}
```

## 6、添加专业

### 6.1、点击列表页面显示添加专业的窗口

resources/views/admin/profession/index.blade.php



### 6.2、显示添加专业的表单信息



### 6.3控制器加载视图

Http/Controllers/Admin/ProfessionController.php



### 6.4、修改表单内容

#### 6.4.1、模板继承

resources/views/admin/profession/add.blade.php



#### 6.4.2、修改表单

resources/views/admin/profession/add.blade.php

#### 6.4.3、webuploader插件来完成图片上传

对于我们的文件上传，可以使用webuploader插件来完成。
官网：http://fex.baidu.com/webuploader
使用详情查看今天的附件：Laravel框架 - webuploader.doc



因为h-ui.admin框架，已经内置了webuploader插件了，所以我们不需要下载插件，直接在页面中引入webuploader插件的静态资源就可以了。
引入代码：

resources/views/admin/profession/add.blade.php



```html
<div class="row cl">
    <label class="form-label col-xs-4 col-sm-3">logo：</label>
    <div class="formControls col-xs-8 col-sm-9">
        <input type="hidden" name="logo">
        <div id="webuploader-btn">选择文件</div>
        <div class="btn btn-primary radius webuploader-start">开始上传</div>
        {{-- 上传文件的进度条 --}}
        <div id="processing">
            <div class="progress" style="width: 400px">
                <span class="progress-bar">
                    <span class="sr-only" style="width: 0%"></span>
                </span>
            </div>
        </div>
        <div id="webuploader-img"></div>{{-- 预览图片的容器 --}}
    </div>
</div>
```

js代码

```js
// webuploader插件的初始化配置
var uploader = WebUploader.create({
    // 是否开启自动上传
    auto: false,
    // 兼容低版本浏览器时，使用的swf文件地址
    swf: "{{ asset('back') }}/lib/webuploader/0.1.5/Uploader.swf",
    // 选择图片的按钮
    pick: '#webuploader-btn',
    // 是否开启压缩上传图片功能
    resize: false,
    // 限制上传文件的类型
    accept: {
        // extensions: 'gif,jpg,jpeg,png',
    },
    // 设置文件上传地址
    server: "{{url('/admin/upload/subject')}}",
    // 设置Token值
    formData: {
        '_token': '{{ csrf_token() }}',
    },
    // 设置上传文件框的name值
    fileVal: 'subject',
    chunked: true,
});

// webuploader插件的上传图片预览功能
var preview = $('#webuploader-img'); // 显示图片的标签
uploader.on('fileQueued', function(file) {
    uploader.makeThumb(file, function(error, src) {
        preview.empty();
        $('#processing .sr-only').css('width', '0%'); // 清空进度条效果
        if (error) {
            layer.msg("不能预览图片。");
            return;
        }
        preview.html("<img src='" + src +"' />");
    }, 100, 100);
});

// 上传文件的进度
uploader.on('uploadProgress', function(file, percentage) {// percentage 表示上传进度
    $('#processing .sr-only').css('width', percentage * 100 + '%')
});

// 设置点击上传图片
$('.webuploader-start').on('click', function(){
    uploader.upload();
});

// 当前上传文件以后，修改 隐藏域中的文件的图片地址
uploader.on('uploadSuccess', function(file, response){
    if( response.status ){
        $('input[name=logo]').val( response.message );
        layer.msg('上传文件成功了！',{icon:1,time:1500});
    }else{
        preview.empty(); // 清空缩略图
        $('#processing .sr-only').css('width', '0%'); // 清空进度条效果
        layer.msg('上传文件失败了！',{icon:2,time:1500});
    }
});
```

### 6.5、数据入库

#### 6.5.1、控制器代码

Http/Controllers/Admin/ProfessionController.php



#### 6.5.2、视图代码

resources/views/admin/profession/add.blade.php



#### 6.5.3、显示列表页中专业的图片

resources/views/admin/profession/index.blade.php



## 7、删除专业

> 使用ajax删除专业，注意，这里是软删除。所以不要真的去删除图片。
> 步骤：
> 1.发送ajax到后台控制器
> 2.控制器接收ajax请求，使用delete进行删除，返回操作结果。
> 3.前端接收删除操作结果以后，进行提示并更新页面。

### 7.1、发送ajax到后台控制器

视图代码：resources/views/admin/profession/index.blade.php

```js
/*管理员-学科-删除*/
function profession_del(obj,id){
	layer.confirm('学科删除须谨慎，确认要删除吗？',function(index){
		//此处请求后台程序，下方是成功后的前台处理……
		var data = {
		    '_method': 'delete',
			'_token': '{{csrf_token()}}'
		};
		$.post('/admin/profession/'+id, data, function(msg){
		    if(msg.status){
                layer.msg('删除成功',{icon:6,time:1000}, function(){
					location.reload();
                });
			}else{
                layer.msg('删除失败',{icon:5,time:1000});
			}
		});
	});
}
```

控制器代码：app/Http/Controllers/Admin/ProfessionController.php

```php
public function destroy(Profession $profession)
{
    if($profession->delete() !== false){
        return ['status'=> true, 'message'=>'删除成功'];
    }else{
        return ['status'=>false, 'message'=>'删除失败'];
    }
}
```

## 8、编辑专业

> 类似于添加专业，我们也使用layer弹窗来完成，同样，使用ajax提交数据。
> 步骤：
> 1.点击编辑某一个专业，弹窗编辑专业的弹窗。【前面已经完成了】
> 2.在编辑专业的页面中查询和显示对应学科的内容
> 3.把表单数据提交到控制器中
> 4.控制器接收并验证数据
> 判断是否有图片上传，如果有图片，则删除旧图片，保存新图片。
>                        如果没有图片上传，则保留原有图片。
>
> 5.前端接收操作结果，并进行提示和关闭编辑窗口。

### 8.1、显示编辑页面

控制器代码



视图

复制resources/views/admin/profession/add.blade.php文件，并重命名为edit.blade.php



数据回显

resources/views/admin/profession/edit.blade.php



### 8.2、更新数据

app/Http/Controllers/Admin/ProfessionController.php





# 八、总结

1、初始化项目

​	设置时区：config/app.php

2、插件dataTable

​	显示subject列表页信息

3、学科管理列表

​	创建一个资源控制器

​	定义一个资源路由